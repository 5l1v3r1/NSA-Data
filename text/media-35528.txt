TOP SECRETNCOMINTNREL TO USA, AUS, CAN, GBR, NZLH20291123

 

 

 

 

 

 

TURMOIL

IPSEC VPN

SESSIONIZATION

Issue No.1 ..

Issue Date 08/15/08 ..

Responsible Authority

Product Approver ..

DERIVED FROM: NSAICSSM 1-52
DATED: 20041123
DECLASSIFY ON: 20291123
TOP SECRETIICOMINTNREL TO USA, AUS, CAN, GBR, NZLN20291123

TOP SECRETNCOMINTNREL TO USA, AUS, CAN, GBR, NZL1120291123

Derived From: 1-52
Dated: 20041123
DECLASSIFY On: 20291123

Table of Contents

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

Revision Historv .. 4
Reference Documents .. 4

1.0 (U) SCOPE ..5
2.0 ESP SESSIONIZATION ..5
2.1 (S) ..5
2.1.1 (5) Detection .. 5
2.1.2 (5) Sessionizing .. 6
213(5) The Stack .. 6

2.2 (S) ..7
2.2.1 (5) Detection .. 7
2.2.2 (5) Sessionizing .. 7
223(5) The Stack .. 8

3.0 IKE SESSIONIZATION ..9
3.1 (U) ..9
3.1.1 (5) Detection .. 9
3.1.2 (5) Sessionizing .. 9
3.1.3 (5) The Stack .. 10

3.2 (U) ..10
3.2.1 (5) Detection .. 10
3.2.2 (5) Sessionizino .. 11
3.2.3 (U) The Stack .. 12

3.3 (U) .. 12
3.3.1 (5) Detection .. 12
3.3.2 (5) Sessionizino .. 13
3.3.3 (5) The Stack .. 14

3.4 (U) ..14
3.4.1 (5) Detection .. 14
3.4.2 (5) Sessionizing .. 15
3.4.3 (5) The Stack .. 16

4.0 (U) SUMMARY ..17

PAGE 2 OF 18

TOP SECRETNCOMINTNREL TO USA, AUS, CAN, GBR, NZLN20291123

TOP SECRETHCOMINTHREL TO USA, AUS, CAN, GBR, NZL1120291123

PAGE 3 OF 18
TOP SECRETHCOMINTNREL TO USA, AUS, CAN, GBR, NZLII20291123

REVISION HISTORY

TOP SECRETHCOMINTHREL TO USA, AUS, CAN, GBR, NZL1120291123

 

 

 

 

 

 

 

 

 

Issue Date Author Amendments
0.1 8/15/08 ET First draft of document
REFERENCE DOCUMENTS
1.
PAGE 4 OF 18

TOP SECRETHCOMINTNREL TO USA, AUS, CAN, GBR, NZLH20291123

 

TOP SECRETHCOMINTHREL TO USA, AUS, CAN, GBR, NZL1120291123

1.0 (U) SCOPE

This document describes the sessionization requirements for the various lPSec VPN protocols processed
in Turmoil. The list of lPSec protocol stacks of interest is shown here:












Currently, and are successfully sessionized by the Other lPSec stacks have
been observed in the field, and we have requirements to process them in Turmoil. For completeness, all
of the stacks are discussed in this document, even though some are currently being processed.

2.0 (S) ESP SESSIONIZATION

2.1 (5) IPIESP

2.1.1 (5) DETECTION

The AEG loads the FSPF with the following keyword and mask pair for this protocol:

keywordmaskThis indicates that the packets that satisfy the following parameters will be selected by this keyword for
processing in the 

packet

lP Header Length 5

lP Next Protocol ESP (0x32)
ESP Sequence Number 5

The ESP Sequence Number requirement implements a "sampling" function on the ESP, reducing the
ESP traffic by a factor of 1/16, to limit the ESP loading in the AEG.

PAGE 5 OF 18
TOP SECRETHCOMINTHREL TO USA, AUS, CAN, GBR, NZLH20291123

TOP SECRETNCOMINTNREL TO USA, AUS, CAN, GBR, NZL1120291123

2.1.2 (S) SESSIONIZING

The ESP packets would be sessionized by the following set of parameters:

lP Next Protocol 50 (0x32)
lP Source Address

lP Destination Address

ESP Spi

2.1.3 (S) THE STACK

The fields utilized in sessionization are highlighted in red in the diagram belowType Total length (bytes) 
|Version| Header| of service 
(T05) 

Identification |3 bit| Fragment offset 
f149i 

|0 








. 











IFFI


Time Next Header checksum

to live (TTL) protocol 



source IP address

destination IP address

options (if any) 





























Security Parameters Index AInt.
|Cov-
Sequence Number

Payload Data (variable)















Padding (@-255 bytes) 













3


I



Pad Length Next Header

Integrity Check Value-ICV (variable)

. 



PAGE 6 OF 18
TOP SECRETNCOMINTNREL TO USA, AUS, CAN, GBR, NZLN20291123

TOP SECRETIICOMINTIIREL TO USA, AUS, CAN, GBR, NZLII20291123

2.2 (5) IPIAHIESP

2.2.1 (5) DETECTION

The AEG loads the FSPF with the following keyword and mask pair for this protocol:

keywordmaskThis indicates that the packets that satisfy the following parameters will be selected by this keyword for
processing in the 

packet

lP Header Length 5

lP Next Protocol AH (0x33)

AH Next Payload ESP (0x32)
ESP Sequence Number 5

2.2.2 (5) SESSIONIZING

The packets would be sessionized by the following set of parameters:

lP Next Protocol 51 (0x33)
lP Source Address

lP Destination Address

AH Next Payload 50 (0x32)
AH Spi

ESP Spi

The software FSPF is currently programmed to recognize only TCP, UDP, and ESP as valid Network
Layers. However, since our ke ords start at the Network (IP) Layer, those packets will make it
through the FSPF to the AEG. ?said that the change to the FSPF to recognize AH at the
Transport Layer would be easy to implement.

The DFCE does not currently recognize AH as a valid Transport Layer, and that change will apparently be
difficult to implement. The new idea is to develop ?application-specific demux" components for the TE,
that will perform any desired sessionization based on parameters after the Network (IP) Layer.

PAGE 7 OF 18
TOP SECRETIICOMINTIIREL TO USA, AUS, CAN, GBR, NZLII20291123

TOP SECRETIICOMINTIIREL TO USA, AUS, CAN, GBR, NZLII20291123

2.2.3 (S) THE STACK

|Version| Header|
length|

.-
a.
.-


Identification



Time

to live (TTL) 


Type Total length (bytes)
of service 

(T05) 

|3 bit|
flag|
|0 
IFFI

Fragment offset
Next Header checksum

protocol 

source IP address



destination IP address



options (if any)



Next Header

Payload Len RESERVED



Security Parameters Index



Sequence Number



Integrity Check Value-ICV (variable)



Security Parameters Index



Sequence Number

Payload Data (variable)









Padding (@-255 bytes)

Pad Length Next Header



Integrity Check Value-ICV

(variable)



PAGE TOP SECRETIICOMINTIIREL TO USA, AUS, CAN, GBR, NZLII20291123

TOP SECRETIICOMINTIIREL TO USA, AUS, CAN, GBR, NZLII20291123

3.0 (S) IKE SESSIONIZATION
3.1 (U) IPIUDPIISAKMP

3.1.1 (5) DETECTION

The AEG loads the FSPF with the following keyword and mask pair for this protocol:

keywordmaskThis indicates that the packets that satisfy the following parameters will be selected by this keyword for
processing in the 

packet

lP Header Length 5

lP Next Protocol UDP (0x11)

ISAKMP Version 0x10

ISAKMP Next Payload, Exchange Type, and Flags fields all have ranges of valid values
ISAKMP Length (header payload) 64k

We have a similar keyword/mask pair for ISAKMP Version 9.9.

3.1.2 (5) SESSIONIZING

The packets would be sessionized by the following set of parameters:

lP Next Protocol UDP (0x11)
lP Source Address

lP Destination Address

UDP Source Port

UDP Destination Port

PAGE 9 OF 18
TOP SECRETIICOMINTIIREL TO USA, AUS, CAN, GBR, NZLII20291123

TOP SECRETIICOMINTIIREL TO USA, AUS, CAN, GBR, NZLII20291123

3.1.3 (S) THE STACK

Time 

|Version| Header|


Next 

protocol 


length|

Identification

Time 
to live (TTL) 

of service 
(TOS) 


|3 bit|
flag|
|0 
IFFI

source IP address

Total length (bytes)

Fragment offset

Header checksum



destination IP address


options (if any)


Destination Port

Message length 





Source Port



Next Payload MjVer MnVer Exchange Type 


Initiator
Cookie

Responder
Cookie

Message ID

Checksum

Flags



Length



3.2 (U) IPIUDPINULLSIISAKMP

3.2.1 (S) DETECTION

The AEG loads the FSPF with the following keyword and mask pair for this protocolkeywordmaskThis indicates that the packets that satisfy the following parameters will be selected by this keyword for
processing in the 

PAGE

10 OF 18

TOP SECRETIICOMINTIIREL TO USA, AUS, CAN, GBR, NZLII20291123

TOP SECRETIICOMINTIIREL TO USA, AUS, CAN, GBR, NZLII20291123

packet

lP Header Length 5

lP Next Protocol UDP (0x11)

4 bytes of NULLS between the UDP and ISAKMP layers

ISAKMP Version 0x10

ISAKMP Next Payload, Exchange Type, and Flags fields all have ranges of valid values
ISAKMP Length (header payload) 64k

We have a similar keyword/mask pair for ISAKMP Version 9.9.

3.2.2 (5) SESSIONIZING

The packets would be sessionized by the following set of parameters:

lP Next Protocol UDP (0x11)
lP Source Address

lP Destination Address

UDP Source Port

UDP Destination Port

PAGE 11 OF 18
TOP SECRETIICOMINTIIREL TO USA, AUS, CAN, GBR, NZLII20291123

TOP SECRETIICOMINTIIREL TO USA, AUS, CAN, GBR, NZLII20291123

3.2.3 (U) THE STACK

Type Total length (bytes)
|Version| Header| of service 
length| (TOS) 

Identification |3 bit| Fragment offset
f149i
|0 
I I Fl

Time Next Header checksum
to live (TTL) protocol 

source IP address

destination IP address

options (if any)

Source Port Destination Port 
UDP



























Message length Checksum 

NULLS 

Initiator
Cookie

Responder
Cookie








ext Payload MjVer MnVer Exchange Type Flags 

Message ID

Length




3.3 (U) IPITCPIISAKMP

3.3.1 (S) DETECTION

The AEG loads the FSPF with the following keyword and mask pair for this protocol:

keywordmaskPAGE 12 OF 18
TOP SECRETIICOMINTIIREL TO USA, AUS, CAN, GBR, NZLII20291123

TOP SECRETIICOMINTIIREL TO USA, AUS, CAN, GBR, NZLII20291123

This indicates that the packets that satisfy the following parameters will be selected by this keyword for
processing in the 

packet

lP Header Length 5

lP Next Protocol TCP (0x06)

ISAKMP Version 0x10

ISAKMP Next Payload, Exchange Type, and Flags fields all have ranges of valid values
ISAKMP Length (header payload) 64k

We have a similar keyword/mask pair for ISAKMP Version 9.9.

3.3.2 (5) SESSIONIZING

The packets would be sessionized by the following set of parameters:

lP Next Protocol TCP (0x06)
lP Source Address

lP Destination Address

TCP Source Port

TCP Destination Port

PAGE 13 OF 18
TOP SECRETIICOMINTIIREL TO USA, AUS, CAN, GBR, NZLII20291123

TOP SECRETIICOMINTIIREL TO USA, AUS, CAN, GBR, NZLII20291123

3.3.3 (S) THE STACK

Next
protocol

source IP address

destination IP address

Source Port Destination Port

3.4 (U) IPITCPINULLSIISAKMP

3.4.1 (5) DETECTION

The AEG loads the FSPF with the following keyword and mask pair for this protocol:

PAGE 14 OF 18
TOP SECRETIICOMINTIIREL TO USA, AUS, CAN, GBR, NZLII20291123

TOP SECRETIICOMINTIIREL TO USA, AUS, CAN, GBR, NZLII20291123

keywordmaskThis indicates that the packets that satisfy the following parameters will be selected by this keyword for
processing in the 

packet

lP Header Length 5

lP Next Protocol TCP (0x06)

4 bytes of NULLS between the TCP and ISAKMP layers

ISAKMP Version 0x10

ISAKMP Next Payload, Exchange Type, and Flags fields all have ranges of valid values
ISAKMP Length (header payload) 64k

We have a similar keyword/mask pair for ISAKMP Version 9.9.

3.4.2 (5) SESSIONIZING

The packets would be sessionized by the following set of parameters:

lP Next Protocol TCP (0x06)
lP Source Address

lP Destination Address

TCP Source Port

TCP Destination Port

PAGE 15 OF 18
TOP SECRETIICOMINTIIREL TO USA, AUS, CAN, GBR, NZLII20291123

TOP SECRETIICOMINTIIREL TO USA, AUS, CAN, GBR, NZLII20291123

3.4.3 (S) THE STACK

Next
protocol

source IP address

destination IP address

Source Port Destination Port

PAGE 16 OF 18
TOP SECRETIICOMINTIIREL TO USA, AUS, CAN, GBR, NZLII20291123

TOP SECRETIICOMINTIIREL TO USA, AUS, CAN, GBR, NZLII20291123

4.0 (U) SUMMARY

The currently recognizes UDP, TCP, and ESP as valid Network Layer protocols, and currently
sessionizes those packet types. The new requirement for will require changes to the to
recognize AH as a valid layer, and will also require changes to the DFCE to allow those packets through.

There has been talk of having application-specific demuxes developed and inserted into the TE to
perform any required sessionization beyond the Transport Layer. For example, the ESP demux would be
responsible for sessionizing on Spi value.

The Table below summarizes the various protocol stacks, the parts of the stacks that are used in PPF
keyword detection, and how the associated packets should be sessionized.

 

Protocol Stack

Keyword Detection Layers

Sessionization Requirements

 

 

 

lP, ESP lP Next Protocol 50
IP Source Address
lP Destination Address
ESP Spi
lP, AH, ESP lP Next Protocol 2 51
IP Source Address
lP Destination Address
AH Next Header 50
AH Spi
ESP Spi
lP, UDP, ISAKMP lP Next Protocol 2 17

we have separate keywords for
ISAKMP Versions 1.0 and 9.9

lP Source Address

lP Destination Address
UDP Source Port

UDP Destination Port

 

 



we have separate keywords for
ISAKMP Versions 1.0 and 9.9

 

lP, UDP, ISAKMP

 

lP Next Protocol 17
IP Source Address

lP Destination Address
UDP Source Port

UDP Destination Port

 

PAGE 17 OF 18

TOP SECRETIICOMINTIIREL TO USA, AUS, CAN, GBR, NZLII20291123

 

TOP SECRETIICOMINTIIREL TO USA, AUS, CAN, GBR, NZLII20291123

 



we have separate keywords for
ISAKMP Versions 1.0 and 9.9

lP, TCP, ISAKMP

lP Next Protocol 6

IP Source Address

lP Destination Address
TCP Source Port

TCP Destination Port

 

 



we have separate keywords for
ISAKMP Versions 1.0 and 9.9

 

lP, TCP, ISAKMP

 

lP Next Protocol 6

IP Source Address

lP Destination Address
TCP Source Port

TCP Destination Port

 

PAGE 18 OF 18

TOP SECRETIICOMINTIIREL TO USA, AUS, CAN, GBR, NZLII20291123

 

